From 2f2ee157f3bd0ee383a84c25b62a7c1350d89d78 Mon Sep 17 00:00:00 2001
From: Yash Goyal <ygoyal@wigwag.com>
Date: Thu, 18 Feb 2021 17:18:34 -0800
Subject: [PATCH] Set optimization level to 0 only if FORTIFY_SOURCE is set to
 <=0

---
 ...01-Fix-CMake-test-Build-Type-Release.patch | 25 +++++++++++++++++++
 cmake/examples_configure.cmake                |  2 +-
 2 files changed, 26 insertions(+), 1 deletion(-)
 create mode 100644 cmake/0001-Fix-CMake-test-Build-Type-Release.patch

diff --git a/cmake/0001-Fix-CMake-test-Build-Type-Release.patch b/cmake/0001-Fix-CMake-test-Build-Type-Release.patch
new file mode 100644
index 0000000..fd32b59
--- /dev/null
+++ b/cmake/0001-Fix-CMake-test-Build-Type-Release.patch
@@ -0,0 +1,25 @@
+From 9cb4ea122c14934704d2bc568d898f2d5ecedc91 Mon Sep 17 00:00:00 2001
+From: Yash Goyal <ygoyal@wigwag.com>
+Date: Thu, 18 Feb 2021 16:45:24 -0800
+Subject: [PATCH] Fix CMake test Build Type Release
+
+---
+ cmake/examples_configure.cmake | 2 +-
+ 1 file changed, 1 insertion(+), 1 deletion(-)
+
+diff --git a/cmake/examples_configure.cmake b/cmake/examples_configure.cmake
+index 2b88151..36d4df0 100644
+--- a/cmake/examples_configure.cmake
++++ b/cmake/examples_configure.cmake
+@@ -14,7 +14,7 @@ if (DEFINED EDGE_CLIENT_REQUEST_TIMEOUT_THRESHOLD_MS)
+ endif ()
+ SET (EDGE_CLIENT_REQUEST_TIMEOUT_THRESHOLD_MS 1800000) # Thirty minute
+ 
+-if (NOT (CMAKE_BUILD_TYPE STREQUAL Release))
++if (NOT (CMAKE_BUILD_TYPE STREQUAL release))
+     SET (CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -O0")
+     SET (CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -O0")
+ endif ()
+-- 
+2.17.1
+
diff --git a/cmake/examples_configure.cmake b/cmake/examples_configure.cmake
index 2b88151..0b29a3f 100644
--- a/cmake/examples_configure.cmake
+++ b/cmake/examples_configure.cmake
@@ -14,7 +14,7 @@ if (DEFINED EDGE_CLIENT_REQUEST_TIMEOUT_THRESHOLD_MS)
 endif ()
 SET (EDGE_CLIENT_REQUEST_TIMEOUT_THRESHOLD_MS 1800000) # Thirty minute
 
-if (NOT (CMAKE_BUILD_TYPE STREQUAL Release))
+if (NOT (CMAKE_BUILD_TYPE STREQUAL Release) AND (NOT (_FORTIFY_SOURCE GREATER 0)))
     SET (CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -O0")
     SET (CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -O0")
 endif ()
-- 
2.17.1

